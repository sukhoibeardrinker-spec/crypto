<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSI Monitor</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      margin: 0;
    }
    h1 { font-size: 1rem; color: #555; letter-spacing: 3px; margin: 0 0 28px; }

    /* Ticker selector */
    .selector { display: flex; gap: 12px; margin-bottom: 28px; flex-wrap: wrap; justify-content: center; }
    .ticker-btn {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: #555;
      padding: 6px 20px;
      font-family: monospace;
      font-size: 0.82rem;
      letter-spacing: 2px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }
    .ticker-btn:hover { border-color: #444; color: #aaa; }
    .ticker-btn.active { border-color: #666; color: #eee; background: #222; }

    /* Table */
    .ticker-title { font-size: 0.82rem; color: #555; letter-spacing: 2px; margin-bottom: 12px; }
    table { border-collapse: collapse; font-size: 0.78rem; }
    th {
      color: #444;
      padding: 4px 14px;
      border-bottom: 1px solid #2a2a2a;
      text-align: right;
      white-space: nowrap;
    }
    th:first-child { text-align: left; }
    td { padding: 3px 14px; text-align: right; color: #999; white-space: nowrap; }
    td:first-child { text-align: left; color: #555; }
    tbody tr:first-child td { color: #eee; font-weight: bold; }

    /* RSI colour coding */
    .rsi-ob { color: #ff4444 !important; }
    .rsi-os { color: #44cc44 !important; }

    /* SHORT signal */
    tr.signal-short { background: rgba(255, 210, 0, 0.07); }
    .signal-tag { color: #ffcc00; font-size: 0.72rem; font-weight: bold; letter-spacing: 1px; }

    /* Misc */
    .updated { font-size: 0.7rem; color: #333; margin-top: 20px; }
    .status-msg { color: #333; font-size: 0.82rem; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>RSI MONITOR</h1>

  <div class="selector" id="selector"></div>
  <div class="ticker-title" id="ticker-title"></div>

  <table id="main-table" style="display:none">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Price</th>
        <th>RSI&nbsp;15m</th>
        <th>RSI&nbsp;1H</th>
        <th>RSI&nbsp;4H</th>
        <th>RSI&nbsp;1D</th>
        <th>Signal</th>
      </tr>
    </thead>
    <tbody id="tbl-body"></tbody>
  </table>

  <div class="status-msg" id="status-msg">Загрузка...</div>
  <div class="updated" id="tbl-updated"></div>

  <script>
    let currentTicker = null;

    /* ── colour helpers ─────────────────────────────────────────── */
    function colorSets(values) {
      const valid = values.filter(v => v !== null);
      const sorted = [...valid].sort((a, b) => a - b);
      return {
        minSet: new Set(sorted.slice(0, 5)),
        maxSet: new Set(sorted.slice(-5)),
      };
    }

    function rsiClass(val, { minSet, maxSet }) {
      if (val === null) return '';
      if (maxSet.has(val)) return 'rsi-ob';
      if (minSet.has(val)) return 'rsi-os';
      return '';
    }

    function fmt(val) {
      return val !== null && val !== undefined ? Number(val).toFixed(2) : '—';
    }

    /* ── render detail table ────────────────────────────────────── */
    function renderDetail(rows) {
      if (!rows.length) {
        document.getElementById('status-msg').textContent = 'Нет данных';
        return;
      }

      const csPr  = colorSets(rows.map(r => r.price));
      const cs15  = colorSets(rows.map(r => r.rsi_15m));
      const cs1h  = colorSets(rows.map(r => r.rsi_1h));
      const cs4h  = colorSets(rows.map(r => r.rsi_4h));
      const cs1d  = colorSets(rows.map(r => r.rsi_1d));

      document.getElementById('tbl-body').innerHTML = rows.map(r => {
        const isShort = r.is_short;
        return `<tr${isShort ? ' class="signal-short"' : ''}>
          <td>${r.time}</td>
          <td class="${rsiClass(r.price, csPr)}">${Number(r.price).toFixed(5)}</td>
          <td class="${rsiClass(r.rsi_15m, cs15)}">${fmt(r.rsi_15m)}</td>
          <td class="${rsiClass(r.rsi_1h,  cs1h)}">${fmt(r.rsi_1h)}</td>
          <td class="${rsiClass(r.rsi_4h,  cs4h)}">${fmt(r.rsi_4h)}</td>
          <td class="${rsiClass(r.rsi_1d,  cs1d)}">${fmt(r.rsi_1d)}</td>
          <td>${isShort ? '<span class="signal-tag">SHORT</span>' : ''}</td>
        </tr>`;
      }).join('');

      document.getElementById('status-msg').style.display = 'none';
      document.getElementById('main-table').style.display = 'table';
    }

    /* ── load selected ticker ───────────────────────────────────── */
    async function loadTicker(symbol) {
      document.getElementById('status-msg').textContent = 'Загрузка...';
      document.getElementById('status-msg').style.display = 'block';
      document.getElementById('main-table').style.display = 'none';
      try {
        const res  = await fetch(`/api/ticker/${symbol}`);
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        document.getElementById('ticker-title').textContent = `${symbol} — RSI-14`;
        document.getElementById('tbl-updated').textContent = json.updated_at ? 'Updated: ' + json.updated_at : '';
        renderDetail(json.data || []);
      } catch (e) {
        console.error(e);
        document.getElementById('status-msg').textContent = 'Ошибка загрузки: ' + e.message;
      }
    }

    /* ── ticker selection ───────────────────────────────────────── */
    function selectTicker(symbol) {
      currentTicker = symbol;
      document.querySelectorAll('.ticker-btn').forEach(btn =>
        btn.classList.toggle('active', btn.dataset.ticker === symbol)
      );
      loadTicker(symbol);
    }

    /* ── init ───────────────────────────────────────────────────── */
    async function init() {
      try {
        const res  = await fetch('/api/table');
        const json = await res.json();
        const tickers = json.tickers || [];

        const selector = document.getElementById('selector');
        selector.innerHTML = tickers.map(t =>
          `<button class="ticker-btn" data-ticker="${t}" onclick="selectTicker('${t}')">${t}</button>`
        ).join('');

        if (tickers.length > 0) selectTicker(tickers[0]);
      } catch (e) {
        console.error(e);
        document.getElementById('status-msg').textContent = 'Не удалось загрузить список тикеров';
      }
    }

    init();
    setInterval(() => { if (currentTicker) loadTicker(currentTicker); }, 60000);
  </script>
</body>
</html>
